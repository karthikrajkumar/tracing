# Enhanced Tracing and Monitoring with Jaeger and Prometheus

This project demonstrates advanced tracing and monitoring capabilities using OpenTelemetry, Jaeger, and Prometheus with a FastAPI application.

## Components

- **FastAPI Application**: A REST API with real database operations and external API calls
- **SQLite Database**: For persistent storage with proper tracing
- **OpenTelemetry**: For distributed tracing
- **Jaeger**: For trace collection and visualization
- **Prometheus**: For metrics collection
- **Grafana**: For metrics visualization

## Features

The application demonstrates several advanced tracing and monitoring features:

1. **Real Database Operations**: Actual SQLite database operations with proper tracing
2. **Real API Calls**: Actual HTTP requests to external APIs with tracing
3. **Custom Spans**: Manual span creation to trace specific operations
4. **Nested Spans**: Parent-child relationships to show operation hierarchy
5. **Custom Attributes**: Business-relevant attributes added to spans
6. **Error Tracking**: Exception recording in spans with proper status codes
7. **Detailed Metrics**: Various Prometheus metrics for monitoring
8. **Middleware**: Request tracking and concurrent request monitoring

## Endpoints

The application provides several endpoints to demonstrate different tracing scenarios:

### Basic Endpoints
- `/hello`: Simple endpoint with basic tracing
- `/health`: Simple health check endpoint
- `/metrics`: Prometheus metrics endpoint
- `/error-simulation`: Demonstrates error tracking in traces

### User Endpoints
- `POST /users`: Create a new user
- `GET /users/{user_id}`: Get a specific user
- `GET /users`: Get all users
- `PUT /users/{user_id}`: Update a user
- `DELETE /users/{user_id}`: Delete a user

### Todo Endpoints
- `POST /users/{user_id}/todos`: Create a todo for a user
- `GET /todos/{todo_id}`: Get a specific todo
- `GET /todos`: Get all todos
- `GET /users/{user_id}/todos`: Get all todos for a user
- `PUT /todos/{todo_id}`: Update a todo
- `DELETE /todos/{todo_id}`: Delete a todo
- `PUT /todos/{todo_id}/complete`: Mark a todo as completed

### External API Endpoints
- `GET /weather/{city}`: Get weather data for a city (makes a real API call)

### Complex Operation Endpoints
- `/db-operation`: Performs a series of database operations with nested spans
- `/complex-operation`: Shows complex nested operations with multiple levels

## Running the Application

### Prerequisites
- Python 3.7+
- Jaeger
- Prometheus
- Grafana (optional)

### Setup and Run

1. Start Jaeger:
   ```
   cd jaeger/jaeger-1.52.0-darwin-amd64
   ./jaeger-all-in-one
   ```

2. Start Prometheus:
   ```
   cd prometheus
   prometheus --config.file=prometheus.yml
   ```

3. Start Grafana (if not already running):
   ```
   grafana-server
   ```

4. Start the FastAPI application using the setup script:
   ```
   cd app
   ./setup_and_run.sh
   ```
   
   Or manually:
   ```
   cd app
   python -m venv venv
   source venv/bin/activate
   pip install -r requirements.txt
   uvicorn main:app --reload
   ```

5. Import the Grafana dashboard:
   - Go to Grafana (usually at http://localhost:3000)
   - Navigate to Dashboards > Import
   - Upload the `grafana/dashboard.json` file or copy-paste its contents

## Testing the Application

A test script is provided to generate trace data:

```
cd app
python test_endpoints.py
```

Options:
- `--runs`: Number of test iterations (default: 10)
- `--concurrency`: Number of concurrent requests (default: 3)
- `--delay`: Delay between runs in seconds (default: 0.5)
- `--host`: Host URL (default: http://localhost:8000)

Example:
```
python test_endpoints.py --runs 20 --concurrency 5
```

## Viewing Traces and Metrics

- **Jaeger UI**: http://localhost:16686
  - Search for traces by service, operation, tags, etc.
  - View detailed span information including custom attributes
  - Analyze trace timelines and dependencies

- **Prometheus**: http://localhost:9090
  - Query metrics using PromQL
  - View raw metric data
  - Create ad-hoc graphs

- **Grafana**: http://localhost:3000
  - View the pre-configured dashboard
  - Create custom visualizations
  - Set up alerts based on metrics

## Understanding the Traces

The application creates various types of spans:

1. **Automatically created spans**: Generated by FastAPI and SQLAlchemy instrumentation
2. **Manual spans**: Created using the tracer in the code
3. **Nested spans**: Showing parent-child relationships

Key span attributes to look for:
- `operation.type`: Type of operation (database, API, etc.)
- `database.name`, `database.system`: Database information
- `http.method`, `http.url`: HTTP request details
- `error.probability`: For error simulation
- `user.id`, `todo.id`: Entity identifiers
- `service.name`, `api.operation`: Service and operation names
- Custom attributes specific to each operation

## Project Structure

- `app/main.py`: FastAPI application with endpoints
- `app/database.py`: SQLite database setup and models
- `app/repositories.py`: Data access layer with database operations
- `app/services.py`: Business logic layer
- `app/schemas.py`: Pydantic models for request/response validation
- `app/metrics.py`: Prometheus metrics definitions
- `app/test_endpoints.py`: Test script to generate trace data
- `app/setup_and_run.sh`: Setup and run script

## Understanding the Metrics

The application exposes several Prometheus metrics:

1. **REQUEST_TIME**: Summary of request processing time
2. **DB_OPERATION_TIME**: Summary of database operation time
3. **API_OPERATION_TIME**: Summary of API operation time
4. **ERROR_COUNTER**: Counter for application errors by type
5. **REQUEST_COUNTER**: Counter for HTTP requests by method, endpoint, and status
6. **REQUEST_LATENCY**: Histogram of request latency by endpoint
7. **CONCURRENT_REQUESTS**: Gauge for concurrent request count

## Extending the Application

To add more tracing capabilities:

1. Create new endpoints in `main.py`
2. Add new models in `database.py`
3. Implement data access in `repositories.py`
4. Add business logic in `services.py`
5. Define request/response models in `schemas.py`
6. Use the tracer to create custom spans:
   ```python
   with tracer.start_as_current_span("span-name") as span:
       span.set_attribute("attribute.name", "value")
       # Your code here
   ```
7. Add new metrics in `metrics.py`
8. Update the Grafana dashboard to visualize the new metrics

## Troubleshooting

- If traces aren't appearing in Jaeger, check that the OTLP exporter is configured correctly and Jaeger is running
- If metrics aren't appearing in Prometheus, check the scrape configuration and that the `/metrics` endpoint is accessible
- For Grafana issues, check the data source configuration and dashboard setup
- For database issues, check that the SQLite database file is created correctly in the `app/data` directory
- If you encounter import errors, make sure all dependencies are installed with `pip install -r requirements.txt`
