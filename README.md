# Enhanced Tracing and Monitoring with Jaeger and Prometheus

This project demonstrates advanced tracing and monitoring capabilities using OpenTelemetry, Jaeger, and Prometheus with a FastAPI application.

## Components

- **FastAPI Application**: A simple API with various endpoints that demonstrate different tracing scenarios
- **OpenTelemetry**: For distributed tracing
- **Jaeger**: For trace collection and visualization
- **Prometheus**: For metrics collection
- **Grafana**: For metrics visualization

## Features

The application demonstrates several advanced tracing and monitoring features:

1. **Custom Spans**: Manual span creation to trace specific operations
2. **Nested Spans**: Parent-child relationships to show operation hierarchy
3. **Custom Attributes**: Business-relevant attributes added to spans
4. **Error Tracking**: Exception recording in spans with proper status codes
5. **Detailed Metrics**: Various Prometheus metrics for monitoring
6. **Middleware**: Request tracking and concurrent request monitoring

## Endpoints

The application provides several endpoints to demonstrate different tracing scenarios:

- `/hello`: Simple endpoint with basic tracing
- `/db-operation`: Simulates database operations with nested spans
- `/external-api`: Simulates external API calls with proper tracing
- `/error-simulation`: Demonstrates error tracking in traces
- `/complex-operation`: Shows complex nested operations with multiple levels
- `/health`: Simple health check endpoint
- `/metrics`: Prometheus metrics endpoint

## Running the Application

1. Start Jaeger:
   ```
   cd jaeger/jaeger-1.52.0-darwin-amd64
   ./jaeger-all-in-one
   ```

2. Start Prometheus:
   ```
   cd prometheus
   prometheus --config.file=prometheus.yml
   ```

3. Start Grafana (if not already running):
   ```
   grafana-server
   ```

4. Start the FastAPI application:
   ```
   cd app
   uvicorn main:app --reload
   ```

5. Import the Grafana dashboard:
   - Go to Grafana (usually at http://localhost:3000)
   - Navigate to Dashboards > Import
   - Upload the `grafana/dashboard.json` file or copy-paste its contents

## Testing the Application

A test script is provided to generate trace data:

```
cd app
python test_endpoints.py
```

Options:
- `--runs`: Number of test iterations (default: 10)
- `--concurrency`: Number of concurrent requests (default: 3)
- `--delay`: Delay between runs in seconds (default: 0.5)
- `--host`: Host URL (default: http://localhost:8000)

Example:
```
python test_endpoints.py --runs 20 --concurrency 5
```

## Viewing Traces and Metrics

- **Jaeger UI**: http://localhost:16686
  - Search for traces by service, operation, tags, etc.
  - View detailed span information including custom attributes
  - Analyze trace timelines and dependencies

- **Prometheus**: http://localhost:9090
  - Query metrics using PromQL
  - View raw metric data
  - Create ad-hoc graphs

- **Grafana**: http://localhost:3000
  - View the pre-configured dashboard
  - Create custom visualizations
  - Set up alerts based on metrics

## Understanding the Traces

The application creates various types of spans:

1. **Automatically created spans**: Generated by FastAPI instrumentation
2. **Manual spans**: Created using the tracer in the code
3. **Nested spans**: Showing parent-child relationships

Key span attributes to look for:
- `operation.type`: Type of operation (database, API, etc.)
- `database.name`, `database.system`: Database information
- `http.method`, `http.url`: HTTP request details
- `error.probability`: For error simulation
- Custom attributes specific to each operation

## Understanding the Metrics

The application exposes several Prometheus metrics:

1. **REQUEST_TIME**: Summary of request processing time
2. **DB_OPERATION_TIME**: Summary of database operation time
3. **API_OPERATION_TIME**: Summary of API operation time
4. **ERROR_COUNTER**: Counter for application errors by type
5. **REQUEST_COUNTER**: Counter for HTTP requests by method, endpoint, and status
6. **REQUEST_LATENCY**: Histogram of request latency by endpoint
7. **CONCURRENT_REQUESTS**: Gauge for concurrent request count

## Extending the Application

To add more tracing capabilities:

1. Create new endpoints in `main.py`
2. Use the tracer to create custom spans:
   ```python
   with tracer.start_as_current_span("span-name") as span:
       span.set_attribute("attribute.name", "value")
       # Your code here
   ```
3. Add new metrics in `metrics.py`
4. Update the Grafana dashboard to visualize the new metrics

## Troubleshooting

- If traces aren't appearing in Jaeger, check that the OTLP exporter is configured correctly and Jaeger is running
- If metrics aren't appearing in Prometheus, check the scrape configuration and that the `/metrics` endpoint is accessible
- For Grafana issues, check the data source configuration and dashboard setup
